<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Area Endpoint</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            background: #16213e;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        h1 {
            color: #00b8d4;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #00b8d4;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #00b8d4;
            border-radius: 5px;
            background: #0f3460;
            color: #fff;
            font-size: 14px;
        }
        button {
            background: #00b8d4;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #0092b8;
        }
        #result {
            margin-top: 30px;
            padding: 20px;
            background: #0f3460;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
        .success {
            color: #00ff00;
        }
        .error {
            color: #ff4444;
        }
        .info {
            color: #00b8d4;
        }
        .warning {
            color: #ffaa00;
        }
        .example {
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Area Endpoint</h1>
        
        <div class="form-group">
            <label>API Base URL:</label>
            <input type="text" id="apiUrl" value="http://localhost:3001" placeholder="http://localhost:3001">
            <div class="example">Ejemplo: http://localhost:3001 o https://julstracker.app</div>
        </div>

        <div class="form-group">
            <label>Latitude (Centro del c√≠rculo):</label>
            <input type="number" step="any" id="lat" value="10.92987" placeholder="10.92987">
        </div>

        <div class="form-group">
            <label>Longitude (Centro del c√≠rculo):</label>
            <input type="number" step="any" id="lng" value="-74.72083" placeholder="-74.72083">
        </div>

        <div class="form-group">
            <label>Radius (metros):</label>
            <input type="number" id="radius" value="28686" placeholder="28686">
            <div class="example">Ejemplo: 1000 = 1km, 28686 = 28.7km</div>
        </div>

        <div class="form-group">
            <label>Device ID (opcional):</label>
            <input type="text" id="deviceId" value="device_85e9fe938c42ea28" placeholder="device_85e9fe938c42ea28">
            <div class="example">Dejar vac√≠o para buscar todos los dispositivos</div>
        </div>

        <button onclick="testEndpoint()">üöÄ Test Endpoint</button>
        <button onclick="testHealth()">üíö Test Health</button>
        <button onclick="clearResult()">üóëÔ∏è Clear</button>

        <div id="result"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            resultDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function clearResult() {
            document.getElementById('result').innerHTML = '';
        }

        async function testHealth() {
            clearResult();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            
            log('=== Testing Health Endpoint ===', 'info');
            log(`URL: ${apiUrl}/api/health`, 'info');
            
            try {
                const response = await fetch(`${apiUrl}/api/health`);
                log(`Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log('Response:', 'success');
                log(JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testEndpoint() {
            clearResult();
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const radius = document.getElementById('radius').value;
            const deviceId = document.getElementById('deviceId').value.trim();

            // Validations
            if (!apiUrl) {
                log('‚ùå API URL is required', 'error');
                return;
            }
            if (!lat || !lng || !radius) {
                log('‚ùå Latitude, Longitude, and Radius are required', 'error');
                return;
            }

            // Build URL
            let url = `${apiUrl}/api/location/area?lat=${lat}&lng=${lng}&radius=${radius}`;
            if (deviceId) {
                url += `&deviceId=${deviceId}`;
            }

            log('=== Starting Area Endpoint Test ===', 'info');
            log(`URL: ${url}`, 'info');
            log('Parameters:', 'info');
            log(`  - Latitude: ${lat}`, 'info');
            log(`  - Longitude: ${lng}`, 'info');
            log(`  - Radius: ${radius}m (${(radius/1000).toFixed(2)}km)`, 'info');
            log(`  - Device ID: ${deviceId || 'ALL DEVICES'}`, 'info');
            log('', 'info');

            try {
                log('üì° Sending request...', 'warning');
                const startTime = Date.now();
                
                const response = await fetch(url);
                const endTime = Date.now();
                const duration = endTime - startTime;

                log(`‚è±Ô∏è Response time: ${duration}ms`, 'info');
                log(`üìä Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`üìã Content-Type: ${response.headers.get('content-type')}`, 'info');
                log('', 'info');

                // Get response text first
                const responseText = await response.text();
                log('Raw response:', 'info');
                log(responseText.substring(0, 500) + (responseText.length > 500 ? '...' : ''), 'info');
                log('', 'info');

                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    log('‚ùå Failed to parse JSON:', 'error');
                    log(parseError.message, 'error');
                    return;
                }

                if (response.ok) {
                    log('‚úÖ SUCCESS!', 'success');
                    log('', 'info');
                    
                    if (Array.isArray(data)) {
                        log(`üìç Found ${data.length} location points`, 'success');
                        
                        if (data.length > 0) {
                            log('', 'info');
                            log('First 3 points:', 'success');
                            data.slice(0, 3).forEach((point, i) => {
                                log(`Point ${i+1}:`, 'success');
                                log(`  Lat: ${point.latitude}, Lng: ${point.longitude}`, 'success');
                                log(`  Device: ${point.device_name || point.device_id}`, 'success');
                                log(`  Distance: ${point.distance ? point.distance.toFixed(2) + 'm' : 'N/A'}`, 'success');
                                log(`  Timestamp: ${new Date(point.timestamp_value).toLocaleString()}`, 'success');
                            });
                            
                            if (data.length > 3) {
                                log(`... and ${data.length - 3} more points`, 'success');
                            }
                        } else {
                            log('‚ö†Ô∏è No data found in the specified area', 'warning');
                            log('Try:', 'warning');
                            log('  - Increasing the radius', 'warning');
                            log('  - Checking if the device has data in the database', 'warning');
                            log('  - Verifying the center coordinates', 'warning');
                        }
                    } else {
                        log('Response data:', 'success');
                        log(JSON.stringify(data, null, 2), 'success');
                    }
                } else {
                    log('‚ùå ERROR RESPONSE', 'error');
                    log(JSON.stringify(data, null, 2), 'error');
                }

            } catch (error) {
                log('', 'error');
                log('‚ùå FETCH ERROR:', 'error');
                log(error.message, 'error');
                log('', 'error');
                log('Possible causes:', 'warning');
                log('  - Backend is not running', 'warning');
                log('  - Wrong API URL', 'warning');
                log('  - CORS issue', 'warning');
                log('  - Network problem', 'warning');
                console.error('Full error:', error);
            }
        }

        // Test on load
        window.addEventListener('load', () => {
            log('üéØ Area Endpoint Tester Ready', 'success');
            log('Click "Test Health" to verify backend connection', 'info');
            log('Click "Test Endpoint" to test the area query', 'info');
        });
    </script>
</body>
</html>
