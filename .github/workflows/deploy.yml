name: Deploy Full-Stack to 4 EC2 Instances

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # AsegÃºrate de tener aquÃ­ tus 4 instancias, por ejemplo: [1, 2, 3, 4]
        instance: [1,2,3,4]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2 Instance ${{ matrix.instance }}
      env:
        HOST: ${{ secrets[format('EC2_HOST_{0}', matrix.instance)] }}
        USER: ${{ secrets[format('EC2_USER_{0}', matrix.instance)] }}
        KEY: ${{ secrets[format('EC2_SSH_KEY_{0}', matrix.instance)] }}
        ENV_BACKEND: ${{ secrets[format('ENV_FILE_BACKEND_{0}', matrix.instance)] }}
        ENV_FRONTEND: ${{ secrets[format('ENV_FILE_FRONTEND_{0}', matrix.instance)] }}
        # Nueva variable que lee el nombre de la instancia desde los secretos
        EC2_NAME: ${{ secrets[format('EC2_NAME_{0}', matrix.instance)] }}
      run: |
        echo "ğŸš€ Iniciando despliegue en la instancia ${{ matrix.instance }}..."
        
        echo "$KEY" > deploy_key
        chmod 600 deploy_key
        
        ssh -o StrictHostKeyChecking=no -i deploy_key ${USER}@${HOST} "
          cd /opt/location-tracker
          
          echo 'ğŸ“¦ Actualizando cÃ³digo desde Git...'
          git pull origin main
          
          echo 'âš™ï¸  Configurando Backend...'
          cd backend
          echo '$ENV_BACKEND' > .env
          npm install
          pm2 restart location-backend || pm2 start server.js --name location-backend
          
          echo 'ğŸ–¥ï¸  Configurando Frontend...'
          cd ../frontend
          # Se crea el .env y se aÃ±ade la nueva variable para el tÃ­tulo
          echo '$ENV_FRONTEND' > .env
          echo 'VITE_APP_TITLE=$EC2_NAME' >> .env
          npm install
          npm run build
          
          echo 'ğŸŒ Recargando Nginx...'
          sudo nginx -t && sudo systemctl reload nginx
          
          echo 'âœ… Despliegue completado exitosamente en la instancia ${{ matrix.instance }}'
        "